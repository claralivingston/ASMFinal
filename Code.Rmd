---
title: "Code"
author: "Clara Livingston & Emily Kaegi"
date: "May 25, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(lme4)
```

#Data Join
```{r}
state <- read.csv("StateData.csv")
team <- read.csv("TeamData.csv",stringsAsFactors = TRUE)

statestuff <- data.frame(state.abb,state.name)
colnames(statestuff) <- c("State","StateName")
state <- full_join(state,statestuff)
state$StateName <- as.character(state$StateName)
state <- state%>%mutate(StateName=ifelse(is.na(StateName),"D.C.",StateName))
team$State <- as.character(team$State)
team <- team%>%mutate(State=ifelse(State=="District of Columbia","D.C.",State))
state <- state%>%mutate(State1=State,State=StateName)
AllData <- right_join(state,team)
AllData <- AllData%>%filter(!is.na(Happiness))
write.csv(AllData,"AllData.csv")

# make strings numeric
AllData$Capacity <- as.numeric(gsub(",", "", AllData$Capacity) )
AllData$FranchiseValue <- as.numeric(gsub(",", "", AllData$FranchiseValue) )

# making percent of home wins as variable

AllData <- AllData %>% mutate(WinPct = HomeWins/HomeGames)
```

# EDA

```{r}
# Team Level Variables
# Basic EDA
# #
boxplot(AllData$WinPct)
summary(AllData$WinPct)
# # Sport
table(AllData$Type)

# # Capacity
hist(AllData$Capacity)
summary(AllData$Capacity)
ggplot(AllData, aes(x=Type, y = Capacity)) + geom_boxplot() 

# # FranchiseValue
hist(AllData$FranchiseValue)
summary(AllData$FranchiseValue)
ggplot(AllData, aes(x=Type, y = FranchiseValue)) + geom_boxplot() 

# # Attendance
hist(AllData$Attendence)
summary(AllData$Attendence)
ggplot(AllData, aes(x=Type, y = Attendence)) + geom_boxplot() 

# # Year
hist(AllData$Year.opened)
tapply(AllData$Capacity, AllData$Year.opened, mean)
tapply(AllData$Year.opened, AllData$Type,mean) # hockey and basketball have newest stadiums and baseball and football have older, with baseball being oldest
```

# Potential Interactions

Significant Looking interactions Level 1:
Capacity and Attandence, sport and franchise, year and sport, sport and attendance, franchise and attendence, sport and capacity
```{r}
# Level 1 Interactions

# make capacity a factor for data exploration
AllData$CapFactor <- cut(AllData$Capacity, breaks = c(0, 18578, 27000,  62250,100000), labels = c("1st Q", "2nd Q", "3rd Q", "4th Q"))

# make franchise a factor for data exploration
AllData$FranchiseFactor <- cut(AllData$FranchiseValue, breaks = c(0, 1.000e+09, 1.350e+09,  2.300e+09,4.900e+09), labels = c("1st Q", "2nd Q", "3rd Q", "4th Q"))

# make attendance a factor for data exploration
AllData$YearFactor <- cut(AllData$Year.opened, breaks = c(0, 1994, 1999,  2004,2019), labels = c("1st Q", "2nd Q", "3rd Q", "4th Q"))


#cap and year
ggplot(AllData, aes(x=Year.opened, y = Capacity, color = WinPct)) + geom_point()+geom_smooth(method=lm)
ggplot(AllData, aes(x=Year.opened,y = WinPct)) + geom_point() + facet_wrap(~CapFactor)+geom_smooth(method=lm) # doesn't appear to be an interaction

#cap and sport
ggplot(AllData, aes(x=Capacity,y = WinPct)) + geom_point() + facet_wrap(~Type)+geom_smooth(method=lm) # Interaction

#cap and franchise $$
ggplot(AllData, aes(x=FranchiseValue,y = WinPct)) + geom_point() + facet_wrap(~CapFactor)+geom_smooth(method=lm) # doesn't appear to be an interaction

#cap and attendance
ggplot(AllData, aes(x=Attendence,y = WinPct)) + geom_point() + facet_wrap(~CapFactor) +geom_smooth(method=lm) # Interaction

# year and sport
ggplot(AllData, aes(x=Year.opened,y = WinPct)) + geom_point() + facet_wrap(~Type) +geom_smooth(method=lm) # potentially...

# year and franchise $
ggplot(AllData, aes(x=FranchiseValue,y = WinPct)) + geom_point() + facet_wrap(~YearFactor) +geom_smooth(method=lm) # nope

# year and attandence
ggplot(AllData, aes(x=Attendence,y = WinPct)) + geom_point() + facet_wrap(~YearFactor) +geom_smooth(method=lm) # nope

# sport and franchise $
ggplot(AllData, aes(x=FranchiseValue,y = WinPct)) + geom_point() + facet_wrap(~Type) +geom_smooth(method=lm) # interaction

# sport and attendance
ggplot(AllData, aes(x=Attendence,y = WinPct)) + geom_point() + facet_wrap(~Type) +geom_smooth(method=lm) # potentially

# franchise $ and attendance
ggplot(AllData, aes(x=Attendence,y = WinPct)) + geom_point() + facet_wrap(~FranchiseFactor) +geom_smooth(method=lm) # potentially

```

Significant Looking Interactions Level 2:
*check all* pop and happy, happy and trump, pop and trump
```{r}
# Level 2 interactions

# pop and happy
ggplot(AllData, aes(x=Population,y = WinPct)) + geom_point() + facet_wrap(~as.factor(Happiness)) +geom_smooth(method=lm) # interaction!

# happy and trump
ggplot(AllData, aes(x=Trump.Vote,y = WinPct)) + geom_point() + facet_wrap(~as.factor(Happiness)) +geom_smooth(method=lm) # interaction!

# pop and trump
# make population a factor for data exploration
AllData$PopFactor <- cut(AllData$Population, breaks = c(0, 6782564, 11694664,  21312211,39776831), labels = c("1st Q", "2nd Q", "3rd Q", "4th Q"))
ggplot(AllData, aes(x=Trump.Vote,y = WinPct)) + geom_point() + facet_wrap(~as.factor(PopFactor)) +geom_smooth(method=lm) # interaction!
```

Significant Looking Interactions Cross Levels:

happiness and capacity, happiness and year, hapiness and sport, population and year, trump and attendance

```{r}
# hap and cap
ggplot(AllData, aes(x=Capacity,y = WinPct)) + geom_point() + facet_wrap(~as.factor(Happiness)) +geom_smooth(method=lm) # interaction!

# hap and year
ggplot(AllData, aes(x=Year.opened,y = WinPct)) + geom_point() + facet_wrap(~as.factor(Happiness)) +geom_smooth(method=lm) # interaction!

# hap and sport
ggplot(AllData, aes(x=Type,y = WinPct)) + geom_boxplot(aes(color = as.factor(Happiness))) # interaction potential

# hap and fran$
ggplot(AllData, aes(x=FranchiseValue,y = WinPct)) + geom_point() + facet_wrap(~as.factor(Happiness)) +geom_smooth(method=lm) # not really

# hap and att
ggplot(AllData, aes(x=Attendence,y = WinPct)) + geom_point() + facet_wrap(~as.factor(Happiness)) +geom_smooth(method=lm) # not really

# pop and cap
ggplot(AllData, aes(x=Population,y = WinPct)) + geom_point() + facet_wrap(~CapFactor) +geom_smooth(method=lm) # not really

# pop and year
ggplot(AllData, aes(x=Population,y = WinPct)) + geom_point() + facet_wrap(~YearFactor) +geom_smooth(method=lm) # potentially

# pop and sport
ggplot(AllData, aes(x=Population,y = WinPct)) + geom_point() + facet_wrap(~Type) +geom_smooth(method=lm) # not really

# pop and fran$
ggplot(AllData, aes(x=FranchiseValue,y = WinPct)) + geom_point() + facet_wrap(~PopFactor) +geom_smooth(method=lm) # not really

# pop and att
ggplot(AllData, aes(x=Attendence,y = WinPct)) + geom_point() + facet_wrap(~PopFactor) +geom_smooth(method=lm) # no

# trump and cap
ggplot(AllData, aes(x=Trump.Vote,y = WinPct)) + geom_point() + facet_wrap(~CapFactor) +geom_smooth(method=lm) # no

# trump and year
ggplot(AllData, aes(x=Trump.Vote,y = WinPct)) + geom_point() + facet_wrap(~YearFactor) +geom_smooth(method=lm) # no

# trump and sport
ggplot(AllData, aes(x=Trump.Vote,y = WinPct)) + geom_point() + facet_wrap(~Type) +geom_smooth(method=lm) # no

# trump and fran$
ggplot(AllData, aes(x=Trump.Vote,y = WinPct)) + geom_point() + facet_wrap(~FranchiseFactor) +geom_smooth(method=lm) # no

# trump and att
AllData$TrumpFactor <- cut(AllData$Trump.Vote, breaks = c(0, 36.50,47.25,  50.40,65.40), labels = c("1st Q", "2nd Q", "3rd Q", "4th Q"))
ggplot(AllData, aes(x=Attendence,y = WinPct)) + geom_point() + facet_wrap(~TrumpFactor) +geom_smooth(method=lm) # potentially

```


#Model Building
```{r}
AllData$Happiness <- as.factor(AllData$Happiness)
AllData <- AllData%>% mutate(Capacity2=scale(Capacity),Population2=scale(Population),FranchiseValue2=scale(FranchiseValue),Attendence2=scale(Attendence),Trump.Vote2=scale(Trump.Vote),Year.opened2=scale(Year.opened))

sports.glmer <- glmer(WinPct~Capacity2+Attendence2+Type+FranchiseValue2+Year.opened2+Capacity2:Attendence2+Type:FranchiseValue2+Year.opened2:Type+Type:Attendence2+FranchiseValue2:Attendence2+Type:Capacity2+(Population2+Trump.Vote2+Happiness)^2+Happiness:Capacity2+Trump.Vote2:Attendence2+Happiness:Type+Population2:Year.opened2+Happiness:Year.opened2+(1|State),family=binomial,data=AllData,weights=HomeGames)

sports.glmer2 <- glmer(WinPct~Capacity2+Attendence2+Type+FranchiseValue2+Year.opened2+Population2+Trump.Vote2+Happiness+(1|State),family = binomial,data=AllData,weights=HomeGames)
```
---
title: "Influence of Stadium and State Characteristics on Home Winning Percentage"
author: "Clara Livingston and Emily Kaegi"
date: "May 25, 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warnings=FALSE, message = FALSE, prompt = TRUE, comment = NULL, fig.align='center')
library(fiftystater)
library(ggplot2)
library(dplyr)
library(stargazer)
library(gridExtra)
```

#Introduction

Typically, when looking at statistics related to sports, researchers tend to focus on the dynamics of the team in question when predicting winning percentages. The goal of our research was to take analysis away from factors related to the team and investigate how factors relating to the location of the team's home stadium affects their home winning percentage. Most people are aware of the phrase "homefield advantage", but just how influential is a team's homefield in boosting their win percentages? SBNation and Sporting News both claim that home field advantage is real across most sports, especially the NBA. What appears harder to determine, however, is the cause of variability in this percentage between different sports and teams. 

Instead of focusing on existance of "homefield advantage" we decided to look at what factors relating to a home stadium or arena might be correlated with winning percentage. Specifically, how do characteristics of the arena, franchise, fan base as well as state metrics affect a home team's winning. Are these characteristics consistent across all major league sports? We chose to focus on the NBA, NFL, MLB, and NHL since these professional leagues are the most popular in the United States.

Some of the most interesting potential predictors we wanted to explore were what percentage of a state's population voted for Donald Trump in the 2016 presidential election. Does political leaning have any correlation with how well teams play at home? Also, using a metric of states' happiness level, we were curious if happiness is in anyway correlated with winning percentage. Do teams in happier states win more? While we cannot determine if this is casual or even the direction of the relationship (are states happy because their teams win or do players in happy states play better?) it is still interesting to explore.

#Methods

Our data is pirmarily in two parts: data related to the state level characteristics and data related to the stadiums of the individual teams. At the state level we chose to focus on three variables related to general state dispositions. The first, population, was gathered from the World Population Review where we collected the approximate population of each state as of the end of 2017. The next variable was from National Geographic's 2017 survey of happiness level at each state where they ranked the overall well-being of adults within each state on a scale from 1 to 5. Adults (18+) were asked to rate their well-being on a scale form 1-100 based on five primary categories: daily life, physical health, location, finances, and companionship. If a state averaged well in these categories, they would be ranked as a 5 for overall well-being and happiness. More on the study can be found in the National Geographic magazine. Finally, we decided to add a variable for the percentage of registered adults that voted for Donald Trump in the 2016 presidential election as recorded by the New York Times. As the country is heaviliy divided on thier beliefs, we were interested to see if this would affect the home team win percentage of the various teams within a given state. 

The second portion of our data was related to the individual major league teams' home stadiums and stadium statistics for the 2017 seasons. We focused our study to baseball (MLB), basketball (MBA), football (NFL), and hockey (NHL). From Wikipedia, we were able to gather the name of the arena or stadium currently being used by active teams, capacity (in thousands), and year opened. It is important to note that across the internet there is some discrepancy in the actual capacity of some of these arenas. Generally, the capacity listed on Wikipedia is fairly accurate for our purposes and will be the variable used in this analysis. In addition to this basic information, we decided to look at the average attendance percentage (people in attendance divided by capacity) for the 2017 season for these teams. This data was collected through ESPN's database on sport statistics for the NFL, MLB, NBA, and NHL. Our final explanatory variable of interest was the franchise values of the teams in questions. We gathered this data from Forbes and recorded it in dollar value. Our interest in the variable primarily comes from the likelihood that teams with larger budgets likely have the flexibility to contract better players and spend more on facilities than teams that do not have this luxury. 

Our dependant variable, home win percentage, was determined using data from Team Rankings. This site provided the home win-loss record for the 2017 seasons. We then used this information to calculate the win percentage by dividing the home wins by total number of games played at home (value between 0 and 1). It is from this data we were able to build our two level model with a random intercept. Minimal information could be collected for the Canadian teams that are part of the major leagues in the United States, thus the 11 data points that were from Canada were removed. 

#Results

In our dataset after removing the Canadian teams, we had 114 different teams to use to investigate how stadium and state factors influenced home game win percentage. Of those 114 teams, 29 were Baseball (MLB), 29 were Basketball (NBA), 32 were Football (NFL), and 24 were Hockey (NHL). 27 states in the United States, including Washington, DC have at least one major league sports team in our dataset.

A summary of the quantitative variables can be found below:

```{r,results='asis',warning=FALSE}
state <- read.csv("StateData.csv")
statestuff <- data.frame(state.abb,state.name)
colnames(statestuff) <- c("State","StateName")
state <- full_join(state,statestuff)
state$StateName <- as.character(state$StateName)
state <- state%>%mutate(StateAbb=State,State=ifelse(State=="DC","District of Columbia",StateName))
state <- state%>%mutate(state2=tolower(State))
AllData <- read.csv("AllData.csv")
AllData <- AllData%>%mutate(state2=tolower(State),WinPct = HomeWins/HomeGames)
AllData3 <- AllData%>%select(Happiness,Trump.Vote,Year.opened,Population,Capacity,FranchiseValue,Attendence,WinPct) 
stargazer(AllData3,header = FALSE)
```

When investigating what variables may be influential in our model, we started with potential random effects. The final model contained only one random effect, the random intercept for state. To help explain the need for such an effect, we can see from the map below that the average win percentage for the 2017 season across all four major league teams is highly variable between states. It should be noted that states in white do not have major league teams and thus are not represented within the data. States like Illinois, New Jersey, and New Mexico had very low average win percentatges. On the opposite end of the spectrum, states like Nevada and Lousisiana had very high average win percentages. It is this variability that helps justify the addition of a random effect for state, given there are 50 states and the addition of a categorical variable would not be appropriate to justify such difference. From here, we decided to run a model with all fixed effects interaction terms that appeared significant in the exploratory data analysis. 
After running a binomial logistic regression with all of the itneractions that appeared significant in EDA, *it became clear that the random effect for state was no longer large enough to justify a place in the model.* (this makes it sounds like we took it out... I think we just don't talk about that and say that it was too many variables) It was also apparent, however, that many of the interaction terms were not significant in this model. To determine what interactions would be influential in the final model, 

```{r,fig.cap="Average Win Percentage by State",results='asis',warning=FALSE}
AllStates <- fifty_states
AllStates$state <- AllStates$id
state <- read.csv("StateData.csv")
statestuff <- data.frame(state.abb,state.name)
colnames(statestuff) <- c("State","StateName")
state <- full_join(state,statestuff)
state$StateName <- as.character(state$StateName)
state <- state%>%mutate(StateAbb=State,State=ifelse(State=="DC","District of Columbia",StateName))
state <- state%>%mutate(state2=tolower(State))
AllData <- read.csv("AllData.csv")
AllData <- AllData%>%mutate(state2=tolower(State),WinPct = HomeWins/HomeGames)
AllData2 <- AllData%>%group_by(state2)%>%summarise(AvgWin=mean(WinPct))


state2 <- state%>%filter(StateAbb!="DC")
#Average percent home games won by state
ggplot() + coord_map() + geom_map(data = AllData2, aes(map_id = state2, fill = AvgWin), map = AllStates) + expand_limits(x = AllStates$long, y = AllStates$lat) + ggtitle("Average Percent Won By State") + labs(x= "Longitute", y  = "Latitude") +scale_fill_gradient(name = "Percent", low="#e6e6ff",high="#000099") +theme_classic()
```

When determining random effects to use in the model, we opted not to include sport type. From our EDA it became clear that the sport had a large influence on win percentage on its own and whne interacting with other terms in our model. While a random effect might capture some of this effect, given we are interested in how influential our explanatory variables are, as it relates to win percentage, we believe we could garner more information if sport were a fixed effects variable in the model. 

From initally data analysis, we discovered fourteen possible interactions. These included six interactions at the stadium/team level, all three at the state level, and five between levels. Of these fourteen interactions, only four were significant in the final model. These interactions are between sport type and attendance, sport type and capacity, state population and happiness, and capacity and attendence.

```{r}
# make capacity a factor for data exploration
AllData$Capacity <- as.numeric(AllData$Capacity)
AllData$CapFactor <- cut(AllData$Capacity, breaks = c(0, 18638, 37366,  63026,100000), labels = c("1st Q", "2nd Q", "3rd Q", "4th Q"))

# make franchise a factor for data exploration
AllData$FranchiseValue <- as.numeric(AllData$FranchiseValue)
AllData$FranchiseFactor <- cut(AllData$FranchiseValue, breaks = c(0, 1.000e+09, 1.350e+09,  2.300e+09,4.900e+09), labels = c("1st Q", "2nd Q", "3rd Q", "4th Q"))

# make attendance a factor for data exploration
AllData$YearFactor <- cut(AllData$Year.opened, breaks = c(0, 1994, 1999,  2004,2019), labels = c("1st Q", "2nd Q", "3rd Q", "4th Q"))

AllData$PopFactor <- cut(AllData$Population, breaks = c(0, 6782564, 11694664,  21312211,39776831), labels = c("1st Q", "2nd Q", "3rd Q", "4th Q"))
```

```{r,fig.cap="Attendance and Capacity by Sport"}
require(gridExtra)

plot1 <- ggplot(AllData, aes(x=Attendence,y = WinPct)) + geom_point() + facet_wrap(~Type) +geom_smooth(method=lm)+labs(title="Home Win Percentage Against Attendance by Sport",x="Attendance",y="Home Win Percentage")+theme_classic()+ theme(text = element_text(size=8))



plot2 <- ggplot(AllData, aes(x=Capacity,y = WinPct)) + geom_point() + facet_wrap(~Type)+geom_smooth(method=lm)+labs(title="Home Win Percentage Against Capacity by Sport",x="Capacity",y="Home Win Percentage")+theme_classic()+ theme(text = element_text(size=8),axis.text.x = element_text(angle = 90))

grid.arrange(plot1,plot2,ncol=2)
```

Looking at Figure 2 of the graphs of attendance vs home win percentage, we see the effect varies by type of sport. Baseball, Football and Hockey all see a positive relationship, as attendance increases, win percentage increases. Basketball on the other hand sees a slight decrease, but it is hard to tell if this is significant from the data since for most teams, attendance is high. 

A similar relationship exists with stadium capacity. However since stadium capacity varies by sport.  *should we insert some of the boxplots here or a table of how these vary by sport* it is hard to tell the true effect on win percentage. This graph suggests that Football, Baseball and Basketball have a postive relationship with capacity and win percentage while hockey has a negative.

```{r, fig.cap="Attendance by Capacity Factor and Population by Happiness"}
require(gridExtra)
plot3 <- ggplot(AllData, aes(x=Population,y = WinPct)) + geom_point() + facet_wrap(~as.factor(Happiness)) +geom_smooth(method=lm)+labs(title="Home Win Percentage Against Population by Happiness",x="State Population",y="Home Win Percentage")+theme_classic()+ theme(text = element_text(size=8),axis.text.x = element_text(angle = 90))

plot4 <- ggplot(AllData, aes(x=Attendence,y = WinPct)) + geom_point() + facet_wrap(~CapFactor) +geom_smooth(method=lm)+labs(title="Home Win Percentage Against Attendance by Capacity Quantiles",x="Attendance",y="Home Win Percentage")+theme_classic()+ theme(text = element_text(size=8))

grid.arrange(plot4, plot3, ncol=2)


```

While both capacity and attendance change their effect on home win percentage with team, we also see an interaction between attendance and capacity. For small capacity stadiums and large stadiums, we see a positive relationship between attendance and home win percentage, while the medium size stadiums don't appear to have a relationship of between attendance and home win percentage. This can be found in Figure 3.

Finally to examine the interaction at the state level, for the most part, as population increases for each happiness level, home win percentage decreases. However, for happiness level 3, there is a positive relationship between population and home win percentage.

Those interactions were found significant in our final model. The heirarchical form of the final model is below. Estimates for the $\beta$ parameters can be found in Table 2. Note that Sport Baseball is the baseline level.

####Level 1 (team level): 
$logodds(homewins) = a_i + \beta_0 Capacity_{ij} + \beta_1 Attendence_{ij} + \beta_2SportBasektball_{ij} + \beta_3SportFootball_{ij} + \beta_4SportHockey_{ij} + \beta_5FranchiseValue_{ij} + \beta_6 YearOpened_{ij} + \beta_7Capacity_{ij}SportBasektball_{ij} + \beta_8Capacity_{ij}SportFootball_{ij} + \beta_9Capacity_{ij}SportHockey_{ij} + + \beta_{10}Attendence_{ij}SportBasektball_{ij} + \beta_{11}Attendence_{ij}SportFootball_{ij} + \beta_{12}Attendence_{ij}SportHockey_{ij} + \beta_{13}Attendence_{ij}Capacity_{ij}$

#### Level 2 (state level): 
$a_i = \alpha_0 + \beta_{14}Population_i + \beta_{15}Happiness_i + \beta_{16}Happiness_{i}Population_{i} + u_i$

Where $u_i$ ~ $Norm(0, \sigma)$. Our model predicted $\hat \sigma =  0.1434$


```{r, results = "asis"}
final.glmer <- readRDS("Final.rds")
stargazer(final.glmer,single.row = TRUE,column.sep.width = "1pt", header = FALSE, covariate.labels = c("Capacity", "Attendance", "Basketball", "Football", "Hockey", "FranchiseValue", "Population", "Happiness", "YearOpened", "Attendance*Basketball", "Attendance*Football", "Attendance*Hockey", "Capacity*Basketball", "Capacity*Football", "Capacity*Hockey", "Population*Happiness", "Capacity*Attendance"))
```

Using the model results, the most significant predictors of home winning percentag were stadium capacity, state population, state happiness level, attendence for hockey games, and type of sport. Many of these variables relate to characteristics of the stadium as well as a team's fan base. The only variable that was completely removed from the model was percent of Trump vote meaning that the percent of people in a state who voted for Trump had no effect on the home winning percentage of a team. 

First we will examine how team level factors effect home win percentage. The first variable is type of sport. Compared to baseball teams (our baseline), basketball teams are 10.9 times more likely to win at home and football teams are 3 more likely to win at home. Hockey on the other hand sees a decrease in home winning odds of 96% compared to baseball. 

For baseball teams, increasing their stadium capacity by 1,039 (the standard deviation of stadium capacity for baseball teams) increased the mean odds of winning at home by 37%. For basketball teams the effect is much stronger. Increasing capacity by basketball arena standard deviation (6,116 seats) increases mean odds of winning at home by 2.8 times. Football teams actually see a decrease of 70.9% in mean home winning odds when they increase their stadium capacity by a standard deviation (11,875 seats). Finally, hockey sees a decrease as well with their home game winning odds decreasing by 99% when they increase their stadium capacity one standard deviation of 998 seats. Increasing stadium size also chances the effect of attendence on odds of home wins since there is an interaction term for these variables. Increasing the baseball stadium capacity by the above amount increases the effect of attendance by 20%. Increasing basketball capacity increases the effect of attendance by 2%, football capacity increases attendence's effect by 38% and hockey 2.7%. Increasing a team's franchise value by $93,5646,568 (the standard deviation of this data) increases odds of winning at home by 14% holding all else constant. Newer stadiums actually decrease the odds of winning. For every 19.8 years newer a stadium is, the mean odds of winning decreases by 8% holding all else constant. Finally, attendance's effect varies by type of sport. Increasing attendence by 18.12 percentage points, decreases the mean odds of home wins by 6% for baseball teams. Increasing attendence by 18.12 percentage points also decreases the odds of home winning for football, but by 60% holding all else constant. For basketball teams, this change increases mean odds by 60% and for hockey, teams odds of winning are 2.3 times higher with higher attendance holding all else constant. 

Moving onto state level effects, increasing a state's population by one standard deviation (11,921,447 people) decreases the odds of home wins by 62% but also has an implication on the effect of happiness since there is an interaction term. Increasing happiness level by 1, increases the mean odds of winning at home by 17% holding all else constant. We can interpret the interaction between happiness and population by if we increase populaton by 11,921,447 people, the effect of happiness increases by 24%. 


#Discussion

*for discussion potentially older well established teams have better winning records while newer teams with newer stadiums do not have same legacy *
*for disscussion this could be because these are smaller more intimate venues so attendence matters more*

#Appendix




```{r,fig.cap="Caption Goes Here",results='asis',warning=FALSE}
AllStates <- fifty_states
AllStates$state <- AllStates$id
state <- read.csv("StateData.csv")
statestuff <- data.frame(state.abb,state.name)
colnames(statestuff) <- c("State","StateName")
state <- full_join(state,statestuff)
state$StateName <- as.character(state$StateName)
state <- state%>%mutate(StateAbb=State,State=ifelse(State=="DC","District of Columbia",StateName))
state <- state%>%mutate(state2=tolower(State))
AllData <- read.csv("AllData.csv")
AllData <- AllData%>%mutate(state2=tolower(State),WinPct = HomeWins/HomeGames)
AllData2 <- AllData%>%group_by(state2)%>%summarise(AvgWin=mean(WinPct))

#Population
#ggplot() + coord_map() + geom_map(data = state, aes(map_id = state2, fill = Population), map = AllStates) + expand_limits(x = AllStates$long, y = AllStates$lat) + ggtitle("Population By State 2017") + labs(x= "Longitute", y  = "Latitude") +scale_fill_distiller(name = "Population", palette = "BuPu") +theme_classic()

#Happiness
#ggplot() + coord_map() + geom_map(data = state, aes(map_id = state2, fill = Happiness), map = AllStates) + expand_limits(x = AllStates$long, y = AllStates$lat) + ggtitle("Happiness By State 2017") + labs(x= "Longitute", y  = "Latitude") +scale_fill_distiller(name = "Happiness", palette = "BuPu") +theme_classic()
```
